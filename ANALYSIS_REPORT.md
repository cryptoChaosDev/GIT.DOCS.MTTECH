# üîç –£–ì–õ–£–ë–õ–ï–ù–ù–´–ô –ê–ù–ê–õ–ò–ó bot.py (5845 —Å—Ç—Ä–æ–∫)

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 23 —è–Ω–≤–∞—Ä—è 2026
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω

---

## üìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- **–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞:** 5845
- **–ö–ª–∞—Å—Å–æ–≤:** 7
- **–§—É–Ω–∫—Ü–∏–π/–º–µ—Ç–æ–¥–æ–≤:** 60+
- **–ò–º–ø–æ—Ä—Ç–æ–≤:** 11
- **–ì–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:** 15+

---

## ‚ùå –ù–ï–ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ï –≠–õ–ï–ú–ï–ù–¢–´

### 1. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ò–º–ø–æ—Ä—Ç—ã

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –£–°–õ–û–í–ù–û –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø
- **`asyncio`** (—Å—Ç—Ä–æ–∫–∞ 1)
  - –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è, –Ω–æ —è–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `main()` —Ñ—É–Ω–∫—Ü–∏–∏
  - **–í–´–í–û–î:** –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å (–Ω—É–∂–µ–Ω –¥–ª—è async)

### 2. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

#### –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
- **`AIORGRAM_AVAILABLE`** (—Å—Ç—Ä–æ–∫–∞ 2077)
  - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –¢–æ–ª—å–∫–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ `False`
  - **–í—ã–≤–æ–¥:** –ú–ï–†–¢–í–´–ô –ö–û–î, –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω
  - **–°—Ç—Ä–æ–∫–∞:** 2077

- **`dp`** (Dispatcher stub) (—Å—Ç—Ä–æ–∫–∞ 2091)
  - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏–µ, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∏–≥–¥–µ
  - **–í—ã–≤–æ–¥:** –ù–ï–ò–°–ü–û–õ–¨–ó–£–ï–ú–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø
  - **–°—Ç—Ä–æ–∫–∞:** 2091

### 3. –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –§—É–Ω–∫—Ü–∏–∏

#### –§—É–Ω–∫—Ü–∏—è: `migrate_user_repos_format()`
- **–°—Ç—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:** 1337
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ
- **–¢–∏–ø:** –ú–ï–†–¢–í–´–ô –ö–û–î - —ç—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–∞ —Ä–∞–Ω–µ–µ
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–¥–∞–ª–∏—Ç—å –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

#### –§—É–Ω–∫—Ü–∏—è: `apply_user_git_config(user_id: int)`
- **–°—Ç—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:** 5681
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
- **–¢–∏–ø:** –ù–ï–ü–û–õ–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –õ–∏–±–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é, –ª–∏–±–æ —É–¥–∞–ª–∏—Ç—å

#### –§—É–Ω–∫—Ü–∏—è: `save_git_config_to_user_data(user_id: int, repo_path: str)`
- **–°—Ç—Ä–æ–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:** 5702
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `configure_ssh_for_git_operation()` –≤ –±–ª–æ–∫–µ try-except
- **–°—Ç–∞—Ç—É—Å:** –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –£–°–õ–û–í–ù–û (–≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫)
- **–ó–∞–º–µ—á–∞–Ω–∏–µ:** –ú–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º–∞ –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

---

## ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–´ –ò –†–ò–°–ö–ò

### 1. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

#### A. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `repo_info` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ `repo_data` (—Å—Ç—Ä–æ–∫–∞ 5648)
```python
# –û–®–ò–ë–ö–ê –≤ —Å—Ç—Ä–æ–∫–µ 5648:
repo_url = repo_info.get('repo_url', '–Ω–µ –∑–∞–¥–∞–Ω')  # ‚úó repo_info –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
repo_url = repo_data.get('repo_url', '–Ω–µ –∑–∞–¥–∞–Ω')  # ‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ
```
**–°—Ç–∞—Ç—É—Å:** üî¥ –û–®–ò–ë–ö–ê - –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `repo_info` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
**–õ–æ–∫–∞—Ü–∏—è:** –§—É–Ω–∫—Ü–∏—è `show_users_management()`, —Å—Ç—Ä–æ–∫–∞ 5648
**–í–ª–∏—è–Ω–∏–µ:** –ë—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

---

### 2. –°–¢–†–£–ö–¢–£–†–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

#### A. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ì–ª–æ–±–∞–ª—å–Ω—ã—Ö –ü–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
–ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ `globals()`:
- `user_edit_sessions` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ `globals().get('user_edit_sessions', {})`)
- `user_doc_sessions` (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, –ø—Ä—è–º–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞)
- `user_config_state`
- `user_config_data`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ - —Å–º–µ—à–∏–≤–∞–Ω–∏–µ –ø—Ä—è–º—ã—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å `globals()` dict
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–ª—É—á—à–µ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å)

#### B. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞

**–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ #1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ LFS**
- –§—É–Ω–∫—Ü–∏—è `get_lfs_lock_info()` (—Å—Ç—Ä–æ–∫–∞ 1690)
- –§—É–Ω–∫—Ü–∏—è `get_lock_info_via_gitlab_api()` (—Å—Ç—Ä–æ–∫–∞ 1782)
- –ö–æ–¥ –≤ `handle_document_upload()` (—Å—Ç—Ä–æ–∫–∞ 3307+)
- –ö–æ–¥ –≤ `lock_document_by_name()` (—Å—Ç—Ä–æ–∫–∞ 3804+)
- –ö–æ–¥ –≤ `unlock_document_by_name()` (—Å—Ç—Ä–æ–∫–∞ 3747+)

**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:** 5-7 —Ä–∞–∑ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏
**–†–∞–∑–º–µ—Ä:** ~200-300 —Å—Ç—Ä–æ–∫ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò–∑–≤–ª–µ—á—å –≤ –∫–ª–∞—Å—Å `LockManager`

**–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ #2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (admin/owner)**
- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `check_lock_status()` (—Å—Ç—Ä–æ–∫–∞ 3937)
- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `force_unlock_request()` (—Å—Ç—Ä–æ–∫–∞ 3886)
- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `fix_lfs_issues()` (—Å—Ç—Ä–æ–∫–∞ 4142)
- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `resync_repository()` (—Å—Ç—Ä–æ–∫–∞ 4626)
- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `commit_all_changes()` (—Å—Ç—Ä–æ–∫–∞ 4299)

**–†–∞–∑–º–µ—Ä:** ~10-15 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –Ω–∞ –∫–∞–∂–¥–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `check_admin_rights(user_id)`

---

## üîß –í–û–ó–ú–û–ñ–ù–û–°–¢–ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

### 1. –†–ï–§–ê–ö–¢–û–†–ò–ù–ì –ö–õ–ê–°–°–û–í

#### A. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `LockManager`
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—Å–µ—è–Ω—ã –ø–æ –∫–æ–¥—É: `get_lfs_lock_info()`, `get_lock_info_via_gitlab_api()`, –∏ —Ç.–¥.
- –õ–æ–≥–∏–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 5+ –º–µ—Å—Ç–∞—Ö

**–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –∫–ª–∞—Å—Å:**
```python
class LockManager:
    def __init__(self, repo_path):
        self.repo_path = repo_path
    
    def get_lock_info(self, file_path):
        """Unified lock info retrieval"""
    
    def create_lock(self, file_path):
        """Create lock atomically"""
    
    def remove_lock(self, file_path, force=False):
        """Remove lock with proper cleanup"""
    
    def is_locked_by_user(self, file_path, user_id):
        """Check lock ownership"""
    
    def get_all_locks(self):
        """Get all repository locks"""
```

**–í—ã–∏–≥—Ä—ã—à:** –£–±–∏—Ä–∞–µ—Ç 200-300 —Å—Ç—Ä–æ–∫ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞

---

#### B. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `PermissionManager`
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 5+ —Ñ—É–Ω–∫—Ü–∏—è—Ö

**–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –∫–ª–∞—Å—Å:**
```python
class PermissionManager:
    @staticmethod
    def is_admin(user_id):
        """Check if user is admin"""
    
    @staticmethod
    def is_lock_owner(user_id, lock_owner):
        """Check if user owns lock"""
    
    @staticmethod
    def can_edit(user_id, target_user_id):
        """Check if user can edit another user's config"""
```

**–í—ã–∏–≥—Ä—ã—à:** 50-100 —Å—Ç—Ä–æ–∫ —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

---

### 2. –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–™–ï–î–ò–ù–ï–ù–ò–Ø

#### A. Git status –∫–æ–º–∞–Ω–¥—ã
**–§—É–Ω–∫—Ü–∏–∏:**
- `git_status()` (—Å—Ç—Ä–æ–∫–∞ 4232)
- `git_pull_rebase_autostash()` (—Å—Ç—Ä–æ–∫–∞ 1550)
- `update_repository()` (—Å—Ç—Ä–æ–∫–∞ 4070)

**–î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞:**
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö:
subprocess.run(["git", "status", "--porcelain"], ...)
subprocess.run(["git", "fetch"], ...)
subprocess.run(["git", "pull", "--rebase"], ...)
```

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
```python
class GitOperations:
    def get_status(self):
        """Get repository status"""
    
    def sync_changes(self, auto_commit_paths=None):
        """Fetch and pull with auto-stash"""
    
    def push_changes(self):
        """Push commits and LFS objects"""
```

---

#### B. –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–∞
- `require_user_repo()` (—Å—Ç—Ä–æ–∫–∞ 1520)
- `handle_doc_selection()` (—Å—Ç—Ä–æ–∫–∞ 2825)
- –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ `download_document()`, `upload_changes()`, `lock_document_by_name()`, –∏ —Ç.–¥.

**–î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ª–æ–≥–∏–∫–∞:**
```python
# –ü–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤–µ–∑–¥–µ:
for file_path in repo_root.rglob(doc_name):
    if (file_path.suffix.lower() == '.docx' and 
        not any(part.startswith('.') for part in file_path.parts) and
        '.git' not in file_path.parts and
        '__pycache__' not in file_path.parts and
        'node_modules' not in file_path.parts):
        doc_path = file_path
        break
```

**–†–∞–∑–º–µ—Ä:** ~8 —Å—Ç—Ä–æ–∫, –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –≤ 7-8 –º–µ—Å—Ç–∞—Ö = 56-64 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
def find_document(repo_root, doc_name):
    """Find document in repository, excluding hidden/system dirs"""
    for file_path in repo_root.rglob(doc_name):
        if is_valid_document(file_path):
            return file_path
    return None
```

---

### 3. –ö–≠–®–ò–†–û–í–ê–ù–ò–ï

#### A. –ö—ç—à User Repos
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `load_user_repos()` (—Å—Ç—Ä–æ–∫–∞ 1046) –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `get_user_repo()` –ö–ê–ñ–î–´–ô –†–ê–ó
- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫—ç—à `user_repos_cache` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- –ü—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ `get_user_repo()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π reload JSON —Ñ–∞–π–ª–∞

**–í—ã–∑–æ–≤—ã –≤ –≥–æ—Ä—è—á–∏—Ö –ø—É—Ç—è—Ö:**
- `get_user_repo()` - –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —á–∞—Å—Ç–æ (–∫–∞–∂–¥—ã–π click)
- `set_user_repo()` ‚Üí `save_user_repos()` + `load_user_repos()`
- –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ = IO –æ–ø–µ—Ä–∞—Ü–∏—è —Å –¥–∏—Å–∫–æ–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TTL –∫—ç—à (–≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ 60 —Å–µ–∫—É–Ω–¥)
```python
class UserRepoCache:
    def __init__(self, ttl=60):
        self.cache = {}
        self.timestamps = {}
        self.ttl = ttl
    
    def get(self, user_id):
        if self._is_valid(user_id):
            return self.cache[user_id]
        return None
    
    def _is_valid(self, user_id):
        if user_id not in self.timestamps:
            return False
        return time.time() - self.timestamps[user_id] < self.ttl
```

**–í—ã–∏–≥—Ä—ã—à:** –£–±–∏—Ä–∞–µ—Ç 5-10 IO –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ –∫–∞–∂–¥—ã–π click –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### B. –ö—ç—à LFS Locks
**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- `get_lfs_lock_info()` (—Å—Ç—Ä–æ–∫–∞ 1690) –≤—ã–∑—ã–≤–∞–µ—Ç `subprocess.run()` –Ω–∞–ø—Ä—è–º—É—é
- –ü—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ö–ê–ñ–î–û–ì–û –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –°–ø–∏—Å–æ–∫ –∏–∑ 20 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ = 20 subprocess –≤—ã–∑–æ–≤–æ–≤ –∫ `git lfs locks`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```python
class LfsLockCache:
    def __init__(self, ttl=30):  # –ö—ç—à –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
        self.cache = {}
        self.timestamp = None
        self.ttl = ttl
    
    def get_all_locks(self, repo_path):
        if self._is_valid():
            return self.cache
        self.cache = self._fetch_locks(repo_path)
        self.timestamp = time.time()
        return self.cache
    
    def invalidate(self):
        self.cache = {}
        self.timestamp = None
```

**–í—ã–∏–≥—Ä—ã—à:** –£–º–µ–Ω—å—à–∞–µ—Ç subprocess –≤—ã–∑–æ–≤—ã —Å O(n) –¥–æ O(1) –Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞

---

### 4. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï - –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø

**–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- `user_action_times` (—Å—Ç—Ä–æ–∫–∞ 37) - –≥–ª–æ–±–∞–ª—å–Ω—ã–π dict –¥–ª—è rate limiting
- `user_doc_sessions` (—Å—Ç—Ä–æ–∫–∞ 2105) - –≥–ª–æ–±–∞–ª—å–Ω—ã–π dict –¥–ª—è —Å–µ—Å—Å–∏–π
- `user_config_state` (—Å—Ç—Ä–æ–∫–∞ 2108) - –≥–ª–æ–±–∞–ª—å–Ω—ã–π dict –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- `user_config_data` (—Å—Ç—Ä–æ–∫–∞ 2109) - –≥–ª–æ–±–∞–ª—å–Ω—ã–π dict –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —á–µ—Ä–µ–∑ `globals()`
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–∞–∫ –ø—Ä—è–º—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ö–∞–æ—Ç–∏—á–Ω–æ—Å—Ç–∏ –∏ –æ—à–∏–±–∫–∞–º

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `SessionManager`
```python
class SessionManager:
    def __init__(self):
        self.rate_limit = {}
        self.doc_sessions = {}
        self.config_state = {}
        self.edit_sessions = {}
    
    def get_user_session(self, user_id):
        return self.doc_sessions.get(user_id)
    
    def set_user_session(self, user_id, data):
        self.doc_sessions[user_id] = data
    
    def clear_user_session(self, user_id):
        self.doc_sessions.pop(user_id, None)
```

**–í—ã–∏–≥—Ä—ã—à:** –£–±–∏—Ä–∞–µ—Ç –ø—É—Ç–∞–Ω–∏—Ü—É, —É–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –æ–±–ª–µ–≥—á–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É

---

## üìà –ü–û–í–¢–û–†–Ø–Æ–©–ò–ô–°–Ø –ö–û–î - –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó

### –ü–∞—Ç—Ç–µ—Ä–Ω #1: –ü–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
**–í—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤:** 7 —Ñ—É–Ω–∫—Ü–∏—è—Ö
**–°—Ç—Ä–æ–∫–∏:**
- `handle_doc_selection()` - 2838
- `download_document()` - 2919
- `upload_changes()` - 2987
- `lock_document_by_name()` - 3741
- `unlock_document_by_name()` - 3692
- `handle_doc_name_input()` - 3146
- `get_document_keyboard()` - 2741

**–ö–æ–¥:**
```python
doc_path = None
for file_path in repo_root.rglob(doc_name):
    if (file_path.suffix.lower() == '.docx' and 
        not any(part.startswith('.') for part in file_path.parts) and
        '.git' not in file_path.parts and
        '__pycache__' not in file_path.parts and
        'node_modules' not in file_path.parts):
        doc_path = file_path
        break
```

**–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:** 56 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ (8 —Å—Ç—Ä–æ–∫ √ó 7 –º–µ—Å—Ç)

---

### –ü–∞—Ç—Ç–µ—Ä–Ω #2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ LFS
**–í—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤:** 5+ —Ñ—É–Ω–∫—Ü–∏—è—Ö
**–°—Ç—Ä–æ–∫–∏:**
- `handle_document_upload()` - 3305
- `lock_document_by_name()` - 3797
- `unlock_document_by_name()` - 3750
- `get_document_keyboard()` - 2741
- `download_document()` - 2939

**–ö–æ–¥:**
```python
rel_path = str(doc_path.relative_to(repo_root)).replace('\\', '/')
try:
    lfs_lock_info = get_lfs_lock_info(rel_path, cwd=repo_root)
    is_locked = lfs_lock_info is not None
except Exception as e:
    logging.warning(f"Failed to get LFS lock info: {e}")
    is_locked = False

# –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
if is_locked and lfs_lock_info:
    lfs_owner = lfs_lock_info.get('owner', '')
    user_repo_info = get_user_repo(message.from_user.id)
    user_github_username = user_repo_info.get('git_username') if user_repo_info else None
    
    is_lock_owner = (
        lfs_owner == str(message.from_user.id) or
        lfs_owner == user_github_username or
        (user_github_username and lfs_owner.lower() == user_github_username.lower())
    )
```

**–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:** 200+ —Å—Ç—Ä–æ–∫ (–¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ 5+ –º–µ—Å—Ç–∞—Ö)

---

## üéØ –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–™–ï–î–ò–ù–ï–ù–ò–Ø

### 1. –§—É–Ω–∫—Ü–∏–∏ —Å –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂–µ–π –ª–æ–≥–∏–∫–æ–π

| –§—É–Ω–∫—Ü–∏—è | –¢–∏–ø | –ü–æ—Ö–æ–∂–∞—è —Ñ—É–Ω–∫—Ü–∏—è | –†–∞–∑–Ω–∏—Ü–∞ |
|---------|------|-----------------|---------|
| `lock_document_by_name()` | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ LFS | `unlock_document_by_name()` | –†–∞–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã git lfs |
| `handle_doc_selection()` | –ü–æ–∏—Å–∫ –¥–æ—Ü–∞ | `download_document()` | –†–∞–∑–Ω–∞—è –ø–æ—Å–ª–µ–¥—É—é—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ |
| `validate_gitlab_token()` | –í–∞–ª–∏–¥–∞—Ü–∏—è | `validate_repository_accessibility()` | –†–∞–∑–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| `configure_ssh_for_git_operation()` | SSH –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ | `configure_gitlab_credentials()` | GitLab-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞ |

---

## ‚úÖ –ß–ê–°–¢–û –ò–°–ü–û–õ–¨–ó–£–ï–ú–´–ï –§–£–ù–ö–¶–ò–ò (> 10 –≤—ã–∑–æ–≤–æ–≤)

1. **`get_user_repo(user_id)`** - 20+ –≤—ã–∑–æ–≤–æ–≤
2. **`get_repo_for_user_id(user_id)`** - 15+ –≤—ã–∑–æ–≤–æ–≤
3. **`load_user_repos()`** - 15+ –≤—ã–∑–æ–≤–æ–≤
4. **`save_user_repos(m)`** - 10+ –≤—ã–∑–æ–≤–æ–≤
5. **`get_document_keyboard()`** - 8+ –≤—ã–∑–æ–≤–æ–≤
6. **`get_main_keyboard()`** - 8+ –≤—ã–∑–æ–≤–æ–≤
7. **`require_user_repo(message)`** - 8+ –≤—ã–∑–æ–≤–æ–≤
8. **`format_datetime()`** - 8+ –≤—ã–∑–æ–≤–æ–≤
9. **`log_to_group()`** - 8+ –≤—ã–∑–æ–≤–æ–≤
10. **`subprocess.run(["git",...])`** - 30+ –≤—ã–∑–æ–≤–æ–≤

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ - –†–ï–ó–Æ–ú–ï

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –õ–æ–∫–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –î–µ–π—Å—Ç–≤–∏–µ |
|---|----------|---------|--------|----------|
| 1 | `repo_info` –≤–º–µ—Å—Ç–æ `repo_data` | 5648 | –û–®–ò–ë–ö–ê | üî¥ –°–†–û–ß–ù–û –ò–°–ü–†–ê–í–ò–¢–¨ |
| 2 | –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è `AIORGRAM_AVAILABLE` | 2077 | –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥ | ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å |
| 3 | –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è `dp` | 2091 | –ú–µ—Ä—Ç–≤—ã–π –∫–æ–¥ | ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å |
| 4 | –§—É–Ω–∫—Ü–∏—è `migrate_user_repos_format()` | 1337 | –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è | ‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å/–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å |
| 5 | 200+ —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ | 1690+ | –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ | üü° –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å |
| 6 | –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `globals()` | 5042+ | –ë–µ—Å–ø–æ—Ä—è–¥–æ–∫ | üü° –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å |
| 7 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è LFS locks | 1690+ | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | üü° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å |

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–º–ø–æ—Ä—Ç–æ–≤:** 0 (–≤—Å–µ –Ω—É–∂–Ω—ã)
- **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:** 2 (`migrate_user_repos_format`, `apply_user_git_config`)
- **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:** 2 (`AIORGRAM_AVAILABLE`, `dp`)
- **–ü–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞:** 256+ —Å—Ç—Ä–æ–∫ (–≤ 5+ –º–µ—Å—Ç–∞—Ö)
- **–í–æ–∑–º–æ–∂–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:** 7 –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–±–ª–∞—Å—Ç–µ–π
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫:** 1 (`repo_info` –≤–º–µ—Å—Ç–æ `repo_data`)

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ò–ó–ê–¶–ò–ò

### –°–†–û–ß–ù–û (–¥–æ –∑–∞–ø—É—Å–∫–∞ –≤ production):
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ 5648 (`repo_info` ‚Üí `repo_data`)
2. ‚úÖ –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ/—Ñ—É–Ω–∫—Ü–∏–∏
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å try-catch –¥–ª—è `show_users_management()`

### –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (—É–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏):
4. üü° –°–æ–∑–¥–∞—Ç—å `LockManager` –∫–ª–∞—Å—Å (—É–±–∏—Ä–∞–µ—Ç 200+ —Å—Ç—Ä–æ–∫)
5. üü° –°–æ–∑–¥–∞—Ç—å `PermissionManager` –∫–ª–∞—Å—Å (—É–±–∏—Ä–∞–µ—Ç 50+ —Å—Ç—Ä–æ–∫)
6. üü° –°–æ–∑–¥–∞—Ç—å helper —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—É–±–∏—Ä–∞–µ—Ç 56 —Å—Ç—Ä–æ–∫)

### –°–†–ï–î–ù–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å):
7. üü† –î–æ–±–∞–≤–∏—Ç—å TTL –∫—ç—à –¥–ª—è user repos
8. üü† –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à –¥–ª—è LFS locks
9. üü† –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

### –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢ (–∫–æ–¥ style):
10. üîµ –°–æ–∑–¥–∞—Ç—å `SessionManager` –∫–ª–∞—Å—Å
11. üîµ –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
12. üîµ –î–æ–±–∞–≤–∏—Ç—å type hints

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ö–æ–¥ `bot.py` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- ‚úÖ –•–æ—Ä–æ—à—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å –∫–ª–∞—Å—Å–∞–º–∏ –¥–ª—è VCS –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚ö†Ô∏è –û–¥–∏–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, —Ç—Ä–µ–±—É—é—â–∞—è —Å—Ä–æ—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- üü° 200+ —Å—Ç—Ä–æ–∫ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞, —Ç—Ä–µ–±—É—é—â–µ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- üîµ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –•–æ—Ä–æ—à–µ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (—Ö–æ—Ç—è –µ—Å—Ç—å –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è)

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –æ–±—ä–µ–º —Ä–∞–±–æ—Ç:** 5-8 —á–∞—Å–æ–≤ –Ω–∞ –ø–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô –¥–ª—è production –æ–∫—Ä—É–∂–µ–Ω–∏—è
